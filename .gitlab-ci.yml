
before_script:
  - export VERSION=$(grep -e '^version:' hasklepias.cabal | sed 's/version:[[:space:]]*//g')
  - export NAME=$(grep -e '^name:' hasklepias.cabal | sed 's/name:[[:space:]]*//g')

variables:
  PKG: hasklepias 

stages:
  - docker
  - build
  - release
  - docs
  - upload-docs

docker-build:
 stage : docker
 image: docker:19.03.8
 script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin  $CI_REGISTRY
    - docker build --tag $CI_REGISTRY_IMAGE/$PKG-build:$VERSION --tag $CI_REGISTRY_IMAGE/$PKG-build:latest .
    - docker push $CI_REGISTRY_IMAGE/$PKG-build:$VERSION
    - docker push $CI_REGISTRY_IMAGE/$PKG-build:latest

build-asclepias:
  stage: build
  needs: ["docker-build"]
  # NOTE: I couldn't get the $VERSION variable to work as in:
  #  image : registry.novisci.com/nsstat/asclepias/$PKG-build:$VERSION
  # hence, using latest tag, but this may not be ideal
  image: registry.novisci.com/nsstat/asclepias/$PKG-build:latest
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - dist-newstyle/
  script:
    - ghc --version
    - cabal --version
    - cabal build

install:
  stage: release
  needs: ["build-asclepias"]
  # NOTE: I couldn't get the $VERSION variable to work as in:
  #  image : registry.novisci.com/nsstat/asclepias/$PKG-build:$VERSION
  # hence, using latest tag, but this may not be ideal
  image: registry.novisci.com/nsstat/asclepias/$PKG-build:latest
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - dist-newstyle/
      - install/
  script:
    - ghc --version
    - cabal --version
    - mkdir install
    - cabal install --install-method=copy --installdir=install
    # - aws 
    # - release-cli create --name "Release $CI_COMMIT_SHA" --description "Created using the release-cli $EXTRA_DESCRIPTION" --tag-name "v${MAJOR}.${MINOR}.${REVISION}" --ref "$CI_COMMIT_SHA" --released-at "2020-07-15T08:00:00Z" --milestone "m1" --milestone "m2" --milestone "m3" --assets-link "{\"name\":\"asset1\",\"url\":\"https://example.com/assets/1\",\"link_type\":\"other\"}



test:
  stage: build
  # NOTE: I couldn't get the $VERSION variable to work as in:
  #  image : registry.novisci.com/nsstat/asclepias/$PKG-build:$VERSION
  # hence, using latest tag, but this may not be ideal
  image: registry.novisci.com/nsstat/asclepias/$PKG-build:latest
  cache:
    # https://cabal.readthedocs.io/en/3.4/nix-local-build.html?highlight=dist-newstyle#caching
    key: "$CI_JOB_NAME"
    paths:
      - dist-newstyle/
  script:
    - ghc --version
    - cabal --version
    - cabal test --test-show-details=always 

docs: 
  only: 
    - master
  image: registry.novisci.com/nsstat/asclepias/$PKG-build:latest
  needs: []
  stage: docs
  artifacts:
    paths:
      - dist-newstyle/
      - haddock-output.txt
    expire_in: 1 hour
  script:
    - ghc --version
    - cabal haddock --haddock-html-location='https://hackage.haskell.org/package/$pkg-$version/docs' --enable-documentation  --haddock-hyperlink-source --haddock-quickjump > haddock-output.txt

upload: 
  image: registry.novisci.com/nsstat/statocker/aws:latest
  needs: ["docs"]
  only: 
    - master
  stage: upload-docs
  script:
    - VAR=$(tail -1 haddock-output.txt)
    - aws s3 sync $(dirname $VAR) s3://docs.novisci.com/asclepias/$VERSION/ --delete --acl public-read
    - aws s3 sync $(dirname $VAR) s3://docs.novisci.com/asclepias/latest/ --delete --acl public-read
    - aws cloudfront create-invalidation --distribution-id E171A73GHZQS0B --paths /asclepias/latest/


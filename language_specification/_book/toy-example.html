<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 6 Toy Example | Project Asclepias</title>
  <meta name="description" content="Chapter 6 Toy Example | Project Asclepias">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 6 Toy Example | Project Asclepias" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Toy Example | Project Asclepias" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="features-observational-units-and-cohorts.html">
<link rel="next" href="specifications.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introductions.html"><a href="introductions.html"><i class="fa fa-check"></i><b>1</b> Introductions</a><ul>
<li class="chapter" data-level="1.1" data-path="introductions.html"><a href="introductions.html#emerging-current-approaches"><i class="fa fa-check"></i><b>1.1</b> Emerging, current approaches</a></li>
<li class="chapter" data-level="1.2" data-path="introductions.html"><a href="introductions.html#asceplias-is-different"><i class="fa fa-check"></i><b>1.2</b> Asceplias is different</a></li>
<li class="chapter" data-level="1.3" data-path="introductions.html"><a href="introductions.html#towards-flexible-architectures"><i class="fa fa-check"></i><b>1.3</b> Towards flexible architectures</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="design.html"><a href="design.html"><i class="fa fa-check"></i><b>2</b> Design</a><ul>
<li class="chapter" data-level="2.1" data-path="design.html"><a href="design.html#what-is-does-not-do"><i class="fa fa-check"></i><b>2.1</b> What is does not do</a></li>
<li class="chapter" data-level="2.2" data-path="design.html"><a href="design.html#from-here"><i class="fa fa-check"></i><b>2.2</b> From here</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-types.html"><a href="data-types.html"><i class="fa fa-check"></i><b>3</b> Data Types</a><ul>
<li class="chapter" data-level="3.1" data-path="data-types.html"><a href="data-types.html#interval"><i class="fa fa-check"></i><b>3.1</b> Interval</a></li>
<li class="chapter" data-level="3.2" data-path="data-types.html"><a href="data-types.html#context"><i class="fa fa-check"></i><b>3.2</b> Context</a></li>
<li class="chapter" data-level="3.3" data-path="data-types.html"><a href="data-types.html#contextualized-set"><i class="fa fa-check"></i><b>3.3</b> Contextualized Set</a></li>
<li class="chapter" data-level="3.4" data-path="data-types.html"><a href="data-types.html#events"><i class="fa fa-check"></i><b>3.4</b> Events</a></li>
<li class="chapter" data-level="3.5" data-path="data-types.html"><a href="data-types.html#event-history"><i class="fa fa-check"></i><b>3.5</b> Event History</a></li>
<li class="chapter" data-level="3.6" data-path="data-types.html"><a href="data-types.html#subject"><i class="fa fa-check"></i><b>3.6</b> Subject</a></li>
<li class="chapter" data-level="3.7" data-path="data-types.html"><a href="data-types.html#population"><i class="fa fa-check"></i><b>3.7</b> Population</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="function-types.html"><a href="function-types.html"><i class="fa fa-check"></i><b>4</b> Function Types</a><ul>
<li class="chapter" data-level="4.1" data-path="function-types.html"><a href="function-types.html#accessors"><i class="fa fa-check"></i><b>4.1</b> Accessors</a></li>
<li class="chapter" data-level="4.2" data-path="function-types.html"><a href="function-types.html#predicates"><i class="fa fa-check"></i><b>4.2</b> Predicates</a></li>
<li class="chapter" data-level="4.3" data-path="function-types.html"><a href="function-types.html#filters"><i class="fa fa-check"></i><b>4.3</b> Filters</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="features-observational-units-and-cohorts.html"><a href="features-observational-units-and-cohorts.html"><i class="fa fa-check"></i><b>5</b> Features, observational units, and Cohorts</a><ul>
<li class="chapter" data-level="5.1" data-path="features-observational-units-and-cohorts.html"><a href="features-observational-units-and-cohorts.html#features-and-feature-sets"><i class="fa fa-check"></i><b>5.1</b> Features and Feature sets</a></li>
<li class="chapter" data-level="5.2" data-path="features-observational-units-and-cohorts.html"><a href="features-observational-units-and-cohorts.html#observational-unit"><i class="fa fa-check"></i><b>5.2</b> Observational Unit</a></li>
<li class="chapter" data-level="5.3" data-path="features-observational-units-and-cohorts.html"><a href="features-observational-units-and-cohorts.html#cohort"><i class="fa fa-check"></i><b>5.3</b> Cohort</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="toy-example.html"><a href="toy-example.html"><i class="fa fa-check"></i><b>6</b> Toy Example</a><ul>
<li class="chapter" data-level="6.1" data-path="toy-example.html"><a href="toy-example.html#spade1heart"><i class="fa fa-check"></i><b>6.1</b> 2spade1heart</a></li>
<li class="chapter" data-level="6.2" data-path="toy-example.html"><a href="toy-example.html#foreverdiamonds"><i class="fa fa-check"></i><b>6.2</b> foreverDiamonds</a></li>
<li class="chapter" data-level="6.3" data-path="toy-example.html"><a href="toy-example.html#flush"><i class="fa fa-check"></i><b>6.3</b> flush</a></li>
<li class="chapter" data-level="6.4" data-path="toy-example.html"><a href="toy-example.html#clubtrump"><i class="fa fa-check"></i><b>6.4</b> clubTrump</a></li>
<li class="chapter" data-level="6.5" data-path="toy-example.html"><a href="toy-example.html#fullofhearts"><i class="fa fa-check"></i><b>6.5</b> fullOfHearts</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="specifications.html"><a href="specifications.html"><i class="fa fa-check"></i><b>7</b> Specifications</a></li>
<li class="chapter" data-level="8" data-path="working-example.html"><a href="working-example.html"><i class="fa fa-check"></i><b>8</b> Working example</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Project Asclepias</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="toy-example" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Toy Example</h1>
<p>This example uses data for the single subject defined above to define a <span class="math inline">\(n = 1\)</span> feature set. The subject’s index event is defined as the start of the first <span class="math inline">\(\heartsuit\)</span> after the start of the first <span class="math inline">\(\spadesuit\)</span> (i.e <span class="math inline">\(\text{index}(W) = \mathsf{F}^{\star}(W)\)</span>).</p>
<pre class="sourceCode r"><code class="sourceCode r">index &lt;-<span class="st"> </span>fstar</code></pre>
<p>Define the following features:</p>
<table>
<colgroup>
<col width="34%" />
<col width="40%" />
<col width="26%" />
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Definition</th>
<th>Analogy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2spade1heart</td>
<td>Indicate whether, before index, there are 2 <span class="math inline">\(\spadesuit\)</span> event whose starts are separated by at least 3 time units <em>or</em> 1 <span class="math inline">\(\clubsuit\)</span></td>
<td>“2-out/1-in”</td>
</tr>
<tr class="even">
<td>foreverDiamonds</td>
<td>Indicate whether, after joining all overlapping or adjoined events, the <span class="math inline">\(\diamondsuit\)</span> events have a gap of no more than 5 time units in the time between 25 units before index and up to index</td>
<td>continuous enrollment</td>
</tr>
<tr class="odd">
<td>flush</td>
<td>Indicate whether there is a flush after index; i.e. any set of five consecutive events after index of the same suit. If a flush occurred, keep the time that the flush occurred <em>and</em> what suit triggered the flush.</td>
<td>time to event outcome variable</td>
</tr>
<tr class="even">
<td>clubTrump</td>
<td>Indicate if a <span class="math inline">\(\clubsuit\)</span> occurs after index. If so, keep the time that the first club occurred.</td>
<td>censoring variable</td>
</tr>
<tr class="odd">
<td>fullOfHearts</td>
<td>The set of all <span class="math inline">\(\heartsuit\)</span> event start times that occur between index and clubTrump</td>
<td>longitudinal data</td>
</tr>
</tbody>
</table>
<p>Now let’s express each of these features mathematically.</p>
<div id="spade1heart" class="section level2">
<h2><span class="header-section-number">6.1</span> 2spade1heart</h2>
<p>Let’s define a few more functions that operate on <span class="math inline">\(w\)</span> and <span class="math inline">\(\Xi\)</span>.</p>
<table>
<colgroup>
<col width="20%" />
<col width="48%" />
<col width="31%" />
</colgroup>
<thead>
<tr class="header">
<th>Definition</th>
<th>Mapping</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(any(W) = \begin{cases} W \neq \emptyset &amp; TRUE \\ else &amp; FALSE \end{cases}\)</span></td>
<td><span class="math inline">\(any : \mathcal{W} \mapsto \mathbb{B}\)</span></td>
<td>Is <span class="math inline">\(W\)</span> empty?</td>
</tr>
</tbody>
</table>
<pre class="sourceCode r"><code class="sourceCode r">ANY &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">length</span>(x) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>

compare_head_to_tail_cast &lt;-<span class="st"> </span><span class="cf">function</span>(compareFUN){
  
  <span class="kw">force</span>(compareFUN)
  
  f &lt;-<span class="st"> </span><span class="cf">function</span>(el){
    <span class="cf">switch</span>(
      <span class="dt">EXPR =</span> <span class="kw">as.character</span>(<span class="kw">length</span>(el)),
      <span class="st">&quot;0&quot;</span>  =<span class="st"> </span><span class="kw">list</span>(),
      <span class="st">&quot;1&quot;</span>  =<span class="st"> </span><span class="kw">list</span>(<span class="ot">FALSE</span>),
      <span class="kw">Map</span>(<span class="cf">function</span>(x, h) { <span class="kw">compareFUN</span>(x, <span class="dt">h =</span> h) }, el[<span class="op">-</span>1L], <span class="dt">h =</span> el[1L]) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">Reduce</span>(<span class="st">`</span><span class="dt">|</span><span class="st">`</span>, .) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">append</span>(<span class="kw">f</span>(el[<span class="op">-</span>1L])))
  }
  
  f

}

compare_function_cast &lt;-<span class="st"> </span><span class="cf">function</span>(relation, bound){
  <span class="cf">function</span>(x, h){
    <span class="kw">relation</span>( <span class="kw">s</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">s</span>(h), bound)
  }
}

t2spade1heart &lt;-<span class="st"> </span><span class="cf">function</span>(W){
  <span class="kw">a_cast</span>(<span class="kw">c</span>(<span class="st">&quot;interval&quot;</span>, <span class="st">&quot;a&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw">p_cast</span>(<span class="st">`</span><span class="dt">&lt;</span><span class="st">`</span>, <span class="kw">index</span>(W)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">l_cast</span>() <span class="op">%&gt;%</span>
<span class="st">    </span>{
     {.(<span class="kw">Lsuit_cast</span>(<span class="st">&quot;spade&quot;</span>)(W))} <span class="op">%&gt;%</span>
<span class="st">     </span>{
       w &lt;-<span class="st"> </span>.
       <span class="kw">compare_function_cast</span>(<span class="st">`</span><span class="dt">&gt;=</span><span class="st">`</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">compare_head_to_tail_cast</span>() <span class="op">%&gt;%</span>
<span class="st">         </span>{ w[<span class="kw">unlist</span>(.(w))] } 
     } <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">ANY</span>()  <span class="op">||</span>
<span class="st">     </span>{.(<span class="kw">Lsuit_cast</span>(<span class="st">&quot;club&quot;</span>)(W))} <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">ANY</span>()
    }
}

<span class="co"># No clubs before index</span>
W1 &lt;-<span class="st"> </span>W[<span class="op">-</span><span class="dv">7</span>]
W3 &lt;-<span class="st"> </span>W2 &lt;-<span class="st"> </span>W1
W2[[<span class="dv">6</span>]] &lt;-<span class="st"> </span><span class="kw">event</span>(<span class="dt">interval =</span> <span class="kw">interval</span>(<span class="dt">a =</span> 17L, <span class="dt">b =</span> 17L), 
               <span class="dt">context =</span> <span class="kw">context</span>(<span class="dt">suit =</span> <span class="kw">suit</span>(<span class="st">&quot;spade&quot;</span>), <span class="dt">value =</span> <span class="st">&quot;2&quot;</span>))
W3[[<span class="dv">5</span>]] &lt;-<span class="st"> </span><span class="kw">event</span>(<span class="dt">interval =</span> <span class="kw">interval</span>(<span class="dt">a =</span> 8L, <span class="dt">b =</span> 8L), 
               <span class="dt">context =</span> <span class="kw">context</span>(<span class="dt">suit =</span> <span class="kw">suit</span>(<span class="st">&quot;spade&quot;</span>), <span class="dt">value =</span> <span class="st">&quot;2&quot;</span>))

<span class="kw">t2spade1heart</span>(W)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t2spade1heart</span>(W1)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t2spade1heart</span>(W2)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">t2spade1heart</span>(W3)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>This code will certainly be cleaned up, a key point is that the function is composed of a pattern: <code>filter W -&gt; apply function</code>:</p>
<pre><code>        clubs         spades
           |            |
             before index   
           |            | 
          id         has gaps &gt; 3  
           |            |
          any          any
            \          /
                 or</code></pre>
<p>The key this project is identifying and exploiting such patterns.</p>
<p>Towards a configuration:</p>
<pre><code>filters:
   A: starts of clubs before index
   B: starts of spades with a pairwise distance of starts &gt; 3 before index 
features:
   id: any A or any B</code></pre>
</div>
<div id="foreverdiamonds" class="section level2">
<h2><span class="header-section-number">6.2</span> foreverDiamonds</h2>
<pre><code>any periods of diamonds

</code></pre>
<p><span class="math display">\[
\begin{aligned}
\mathsf{L}^{\diamondsuit}(W) &amp;= \{ w | w \in \mathsf{L}(W&#39;, \mathsf{P}^c(A_t, = \diamondsuit)  \} \\
\text{scangap} &amp;= f(B) = \{(a&#39;, b&#39;) | (a, b) \in B, \,\, a&#39; = \text{if }  x_{i} \leq y_{i - 1} + c \text{ then } x_{i - 1} \text{ else } x_{i} , b&#39; = \text{if }  y_{i} \leq y_{i - 1} \text{ then } y_{i - 1} \text{ else } y_{i}, \forall i = 2, \dots, n  \} \\
\text{periods} &amp;= g(B) = \{(a, b&#39;) | (a, b) \in f(B), \,\, b&#39; = max(b) \,\, \forall a_i = a_j \} \\
\text{pdperiods} &amp;= h(B, pd) = \{ (a, b) | (a, b) \in g(B), \,\, a &gt; \mathsf{a}_s(pd), \, b &lt; \mathsf{a}_e(pd) \} \\
\text{gaps} &amp;= d(B, pd) = \{(a, b) | (a, b) \in B, TODO  \} \\
\text{foreverDiamonds}(W, \text{index}) &amp;= \{\text{if } \{x | (a, b) \in d(h(A_{se}(\mathsf{L}^{\diamondsuit}), (-25, index)), x = b - a, x &gt; 10 \} = \emptyset \text{ FALSE} \text { else } \text{TRUE} \} \\
\end{aligned}
\]</span></p>
<p>Let’s look at the <span class="math inline">\(\text{scangap}\)</span> function and the patterns it can be composed of. First, we have a function performing the nuts and bolts of the set comprehension (e.g., <span class="math inline">\(\text{if } x_{i} \leq y_{i - 1} + c \text{ then } x_{i - 1} \text{ else } x_{i}\)</span>), which be somewhat kludglily patterned as:</p>
<pre class="sourceCode r"><code class="sourceCode r">check_gap_cast &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">cc =</span> <span class="dv">0</span>, <span class="dt">pos =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)) {
  <span class="cf">function</span>(a, b){
    <span class="cf">if</span> (b[pos[<span class="dv">1</span>]] <span class="op">&lt;=</span><span class="st"> </span>(a[pos[<span class="dv">2</span>]] <span class="op">+</span><span class="st"> </span>cc)) a[pos[<span class="dv">3</span>]] <span class="cf">else</span> b[pos[<span class="dv">4</span>]]
  }
}</code></pre>
<p>So that <code>check_gap_cast(cc = 10, pos = c(1, 2, 1, 1))</code> yields <span class="math inline">\(f(x, y) = \text{if } x_{i} \leq y_{i - 1} + 10 \text{ then } x_{i - 1} \text{ else } x_{i}\)</span> and <code>check_gap_cast(cc = 0, pos = c(2, 2, 2, 2))</code> yields <span class="math inline">\(f&#39;(x, y) = \text{if } y_{i} \leq y_{i - 1} \text{ then } y_{i - 1} \text{ else } y_{i}\)</span>.</p>
<p>Then we can apply that pattern to create the scangap function.</p>
<pre class="sourceCode r"><code class="sourceCode r">scangap_cast &lt;-<span class="st"> </span><span class="cf">function</span>(cc){
  <span class="cf">function</span>(l){
    <span class="kw">Reduce</span>(
      <span class="dt">f =</span> <span class="cf">function</span>(x, y){
        <span class="kw">c</span>(<span class="kw">check_gap_cast</span>(cc, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>))(x, y), 
          <span class="kw">check_gap_cast</span>(<span class="dv">0</span>, <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))(x, y))
        },
    <span class="dt">x =</span> l, <span class="dt">accumulate =</span> <span class="ot">TRUE</span>)
  }
}

<span class="kw">scangap_cast</span>(<span class="dv">10</span>)(<span class="kw">head</span>(Wdt<span class="op">$</span>xy))</code></pre>
<pre><code>## [[1]]
## [1] 1 6
## 
## [[2]]
## [1] 1 6
## 
## [[3]]
## [1] 1 6
## 
## [[4]]
## [1] 1 7
## 
## [[5]]
## [1]  1 12
## 
## [[6]]
## [1]  1 17</code></pre>
<p>In summary, scangap return a set of tuples the same length as the input <span class="math inline">\(W\)</span>, where the start and end of each <span class="math inline">\(w_i \in W\)</span> have been updated depending on <span class="math inline">\(w_{i - 1}\)</span> extending the period until a time gap of 10 units occurs.</p>
<p>Now, we can identify which of those periods are the non overlapping periods by scanning the modified periods from the right, accumulating an indicator of whether each period is the longest segment of a period; then we can use set (list) comprehension to filter to the unique periods.</p>
<p>For example, (warning: this is klunky and could be cleaned up), but in <code>R</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Finds the longest non-overlapping periods</span>
scan_periods_cast &lt;-<span class="st"> </span><span class="cf">function</span>(cc){
  <span class="cf">function</span>(l){
     <span class="kw">Map</span>(
       <span class="cf">function</span>(x) <span class="kw">as.logical</span>(x[<span class="dv">3</span>]),
       <span class="kw">Reduce</span>(
         <span class="dt">f =</span> <span class="cf">function</span>(a, b) <span class="kw">c</span>(a, (a[<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>cc <span class="op">&lt;=</span><span class="st"> </span>b[<span class="dv">1</span>]) <span class="op">*</span><span class="st"> </span><span class="dv">1</span>),
         <span class="dt">x =</span> l[<span class="op">-</span><span class="kw">length</span>(l)],
         <span class="dt">init =</span> <span class="kw">c</span>(l[[<span class="kw">length</span>(l)]], <span class="dv">1</span>), <span class="dt">accumulate =</span> <span class="ot">TRUE</span>, <span class="dt">right =</span> <span class="ot">TRUE</span>)
     )
  }
}

period_cast &lt;-<span class="st"> </span><span class="cf">function</span>(cc){
  ff &lt;-<span class="st"> </span><span class="kw">scan_periods_cast</span>(cc)
  gg &lt;-<span class="st"> </span><span class="kw">scangap_cast</span>(cc)
  <span class="cf">function</span>(l){
    <span class="kw">gg</span>(l)[<span class="kw">unlist</span>(<span class="kw">ff</span>(<span class="kw">gg</span>(l)))]
  }
}

<span class="kw">period_cast</span>(<span class="dv">10</span>)(Wdt<span class="op">$</span>xy)</code></pre>
<pre><code>## [[1]]
## [1]  1 67
## 
## [[2]]
## [1] 82 95</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">period_cast</span>(<span class="dv">10</span>)(<span class="kw">head</span>(Wdt<span class="op">$</span>xy))</code></pre>
<pre><code>## [[1]]
## [1]  1 17</code></pre>
<p>Now we have need a function that limits our periods to just those that overlap another period <span class="math inline">\(pd\)</span> (e.g. a lookback period). This is the <span class="math inline">\(pdperiod\)</span> function.</p>
<pre class="sourceCode r"><code class="sourceCode r">pdperiod &lt;-<span class="st"> </span><span class="cf">function</span>(l, p){
  <span class="kw">Filter</span>(
    <span class="dt">f =</span> <span class="cf">function</span>(z) { <span class="op">!</span>(p[<span class="dv">2</span>] <span class="op">&lt;</span><span class="st"> </span>z[<span class="dv">1</span>]) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span>(p[<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span>z[<span class="dv">2</span>]) },
    <span class="dt">x =</span> l
  )  
}

<span class="kw">period_cast</span>(<span class="dv">10</span>)(Wdt<span class="op">$</span>xy) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pdperiod</span>(<span class="dt">p =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">10</span>))</code></pre>
<pre><code>## [[1]]
## [1]  1 67</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">period_cast</span>(<span class="dv">10</span>)(Wdt<span class="op">$</span>xy) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pdperiod</span>(<span class="dt">p =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>))</code></pre>
<pre><code>## [[1]]
## [1]  1 67</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">period_cast</span>(<span class="dv">10</span>)(Wdt<span class="op">$</span>xy) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pdperiod</span>(<span class="dt">p =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">90</span>))</code></pre>
<pre><code>## [[1]]
## [1]  1 67
## 
## [[2]]
## [1] 82 95</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define a couple of helper function</span>
s &lt;-<span class="st"> </span><span class="cf">function</span>(p) p[<span class="dv">1</span>]
e &lt;-<span class="st"> </span><span class="cf">function</span>(p) p[<span class="dv">2</span>]

h &lt;-<span class="st"> </span><span class="cf">function</span>(p1, p2){
  <span class="cf">if</span>(<span class="kw">s</span>(p2) <span class="op">&lt;</span><span class="st"> </span><span class="kw">s</span>(p1) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">e</span>(p2) <span class="op">&lt;=</span><span class="st"> </span><span class="kw">e</span>(p1)){
    <span class="kw">list</span>(<span class="kw">c</span>(<span class="kw">e</span>(p2), <span class="kw">e</span>(p1)))
  } <span class="cf">else</span> <span class="cf">if</span>(<span class="kw">s</span>(p1) <span class="op">&lt;=</span><span class="st"> </span><span class="kw">s</span>(p2) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">e</span>(p1) <span class="op">&lt;</span><span class="st"> </span><span class="kw">e</span>(p2)){
    <span class="kw">list</span>(<span class="kw">c</span>(<span class="kw">s</span>(p1), <span class="kw">s</span>(p2)))
  } <span class="cf">else</span> <span class="cf">if</span>(<span class="kw">s</span>(p1) <span class="op">&lt;=</span><span class="st"> </span><span class="kw">s</span>(p2) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">e</span>(p2) <span class="op">&lt;=</span><span class="st"> </span><span class="kw">e</span>(p1)){
    <span class="kw">list</span>(<span class="kw">c</span>(<span class="kw">s</span>(p1), <span class="kw">s</span>(p2)), <span class="kw">c</span>(<span class="kw">e</span>(p2), <span class="kw">e</span>(p1)))
  } <span class="cf">else</span> {
    <span class="ot">NULL</span>
  }
}

f &lt;-<span class="st"> </span><span class="cf">function</span>(l, p2){
  out  &lt;-<span class="st"> </span>l[<span class="op">-</span><span class="kw">length</span>(l)]
  p1   &lt;-<span class="st"> </span>l[[<span class="kw">length</span>(l)]]
  hold &lt;-<span class="st"> </span><span class="kw">h</span>(p1, p2)
  <span class="kw">append</span>(out, hold)
}

<span class="kw">h</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))
<span class="kw">h</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>))
<span class="kw">h</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">11</span>))

pds &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>),
  <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">15</span>),
  <span class="kw">c</span>(<span class="dv">16</span>, <span class="dv">17</span>)
)

gap_cast &lt;-<span class="st"> </span><span class="cf">function</span>(pd){
  <span class="cf">function</span>(periods){
    <span class="kw">Reduce</span>(f, periods, <span class="dt">init =</span> <span class="kw">list</span>(pd))
  }
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">shift_period &lt;-<span class="st"> </span><span class="cf">function</span>(p, x){
  x <span class="op">+</span><span class="st"> </span>p
}

lookback &lt;-<span class="st"> </span><span class="kw">shift_period</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">25</span>, <span class="dv">0</span>), <span class="kw">index</span>(W))

preindex_gaps &lt;-<span class="st"> </span><span class="kw">gap_cast</span>(lookback)

<span class="co"># period_cast(10)(Wdt$xy) %&gt;% </span>
<span class="co">#   clip_period(p = lookback) </span>
<span class="co"># </span>
<span class="co"># h(lookback, c(1, 67))</span>
<span class="co"># %&gt;%</span>
<span class="co">#   Reduce(f, ., init = list(lookback))</span></code></pre>
<p>Now let’s build foreverDiamonds</p>
<pre class="sourceCode r"><code class="sourceCode r">Ldiamond &lt;-<span class="st"> </span><span class="kw">Lsuit_cast</span>(<span class="st">&quot;diamond&quot;</span>)

foreverDiamonds &lt;-<span class="st"> </span><span class="cf">function</span>(W){
  <span class="kw">Ldiamond</span>(W) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>A_prd <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>{ <span class="kw">period_cast</span>(<span class="dv">10</span>)(.) } <span class="op">%&gt;%</span>
<span class="st">    </span>preindex_gaps <span class="op">%&gt;%</span>
<span class="st">    </span>{ <span class="kw">length</span>(.) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>}
}

<span class="kw">foreverDiamonds</span>(W)</code></pre>
<p>Note that another pattern emerged! <code>Lw</code> is exactly the same pattern as the first part of <code>index</code>!</p>
</div>
<div id="flush" class="section level2">
<h2><span class="header-section-number">6.3</span> flush</h2>
<ul>
<li><span class="math inline">\(\text{flush}(W, \text{index})\)</span></li>
</ul>
</div>
<div id="clubtrump" class="section level2">
<h2><span class="header-section-number">6.4</span> clubTrump</h2>
<ul>
<li><span class="math inline">\(\text{clubTrump}(W, \text{index})\)</span></li>
</ul>
</div>
<div id="fullofhearts" class="section level2">
<h2><span class="header-section-number">6.5</span> fullOfHearts</h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="features-observational-units-and-cohorts.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="specifications.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>

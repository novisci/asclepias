before_script:
  - export MAINVERSION=$(grep -e '^version:' hasklepias-main/hasklepias-main.cabal | sed 's/version:[[:space:]]*//g')

variables:
  PKG: hasklepias
  GHC: 8.10.7

stages:
  - pre-build
  - build
  - install 

# Pre-build stage jobs #### 
docker-build:
 stage : pre-build
 image: docker:20.10.11
 script:
    - ./ci/ci-build-docker.sh $MAINVERSION hasklepias-build haskell $GHC

docker-build-musl:
 stage : pre-build
 image: docker:20.10.11
 script:
    - ./ci/ci-build-docker.sh $MAINVERSION hasklepias-build-musl musl-haskell $GHC

check-source:
  stage: pre-build
  image: registry.novisci.com/nsstat/statocker/haskell:$GHC
  script:
    - ./scripts/lint.sh
    - ./scripts/check_format.sh

# Build stage jobs #### 
build-test-hasklepias:
  stage: build
  needs: ["docker-build", "check-source"]
  # This image is built in docker-build
  image: registry.novisci.com/nsstat/asclepias/hasklepias-build:$MAINVERSION
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - dist-newstyle/
  script:
    - cabal build all && cabal test all

# Install stage jobs ####

# install-cohort-collector:
#   stage: install
#   needs: ["docker-build-musl", "build-test-hasklepias"]
#   image: registry.novisci.com/nsstat/asclepias/musl-haskell:$GHC
#   cache:
#     key: "$CI_JOB_NAME"
#     paths:
#       - dist-newstyle/
#       - install/
#       - cohort-collector*
#   artifacts :
#     name: "${CI_PROJECT_NAME}-${SAFE_REF_NAME}"
#     paths:
#       - "cohort-collector*.tar.gz"
#     expire_in: 1 week
#   script:
#     - export COLLECTORVERSION=$(./scripts/get-version-from-cabal.sh cohort-collector/cohort-collector.cabalcohort-collector/cohort-collector.cabal)
#     # - export COLLECTOR_BUNDLE=cohort-collector-$COLLECTORVERSION-linux-$(uname -m).tar.gz
#     # - ghc --version
#     # - cabal --version
#     # - cabal update
#     # - mkdir install -p
#     # - cabal install cohort-collector --install-method=copy --installdir=install --overwrite-policy=always
#     # - tar -czvf $COLLECTOR_BUNDLE install/cohort-collector
#   # release:
#   #   name: 'Release $TAG'
#   #   description: 'Created using the release-cli $EXTRA_DESCRIPTION'  # $EXTRA_DESCRIPTION and the $TAG
#   #   tag_name: '$TAG'                                                 # variables must be defined elsewhere
#   #   ref: '$CI_COMMIT_SHA'                                            # in the pipeline. For example, in the
#   #   assets:
#   #     links:
#   #       - name: 'asset1'
#   #         url: 'https://download.novisci.com/hasklepias/collector-$VERSION-linux-$CI_RUNNER_EXECUTABLE_ARCH.tar.gz'